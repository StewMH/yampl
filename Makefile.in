CXX = g++
CXXFLAGS = -std=c++11 -O2 -g -Wall -Iinclude -fPIC -Izeromq/include
LDFLAGS = -shared -lpthread -lrt -luuid

SOURCES = $(wildcard src/pipe/*.cpp) \
	  $(wildcard src/ZMQ/*.cpp)  \
	  $(wildcard src/*.cpp)
OBJECTS = $(SOURCES:.cpp=.o)
DEPS = $(SOURCES:.cpp=.d)
LIBIPC = libipc.so
LIBZMQ = ./zeromq/src/.libs/libzmq.a
EXAMPLES = examples
PREFIX = @prefix@
TAGS = tags

all: $(LIBZMQ) $(LIBIPC) $(EXAMPLES) $(TAGS)

$(TAGS):
	ctags -R ./

$(LIBZMQ):
	cd zeromq && ./configure --with-pic && make

-include $(DEPS)

%.o: %.cpp
	$(CXX) $(CXXFLAGS) -MT $@ -MMD -c $< -o $@

$(LIBIPC): $(OBJECTS) $(LIBZMQ)
	$(CXX) $(LDFLAGS) $(OBJECTS) $(LIBZMQ) -o $(LIBIPC)

.PHONY: $(EXAMPLES)
$(EXAMPLES): $(LIBIPC)
	$(MAKE) -C $@

install: all
	mkdir -p $(PREFIX)/lib
	install -s -c -m 0444 $(LIBIPC) $(PREFIX)/lib

uninstall: 
	rm -rf $(PREFIX)/lib/$(LIBIPC)

check:
	./examples/benchmark
	@echo
	./examples/benchmark -i pipe
	@echo
	./examples/benchmark -i splice
	@echo
	./examples/benchmark -i splice -t MANY_TO_ONE
	@echo
	./examples/benchmark -c THREAD

.PHONY: clean
clean:
	$(MAKE) -C $(EXAMPLES) clean
	$(MAKE) -C zeromq clean
	rm -rf $(LIBIPC) $(OBJECTS) $(DEPS) tags
